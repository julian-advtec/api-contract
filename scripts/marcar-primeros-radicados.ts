// scripts/marcar-primeros-radicados.ts
import { DataSource } from 'typeorm';
import { Documento } from '../src/radicacion/entities/documento.entity';
import 'dotenv/config';
import { ormconfig } from '../src/config/ormconfig';

async function marcarPrimerosRadicados() {
    console.log('üöÄ Iniciando proceso para marcar primeros radicados del a√±o...');
    console.log('üìù Este script verifica y corrige los primeros radicados por a√±o');
    
    const dataSource = new DataSource(ormconfig);
    
    try {
        await dataSource.initialize();
        console.log('‚úÖ Conectado a la base de datos');
        
        const documentoRepository = dataSource.getRepository(Documento);
        
        // 1. Primero, desmarcar todos
        console.log('üîÑ Desmarcando todos los documentos...');
        await documentoRepository
            .createQueryBuilder()
            .update(Documento)
            .set({ primerRadicadoDelAno: false })
            .execute();
        
        // 2. Obtener todos los documentos ordenados por fecha de radicaci√≥n
        console.log('üìã Obteniendo documentos ordenados por fecha...');
        
        const documentos = await documentoRepository
            .createQueryBuilder('documento')
            .where("documento.numeroRadicado ~ '^R\\d{4}-\\d{3}$'")
            .orderBy('documento.fechaRadicacion', 'ASC')
            .getMany();
        
        console.log(`üìä Total de documentos v√°lidos a procesar: ${documentos.length}`);
        
        const anosProcesados = new Set<string>();
        let marcados = 0;
        
        // 3. Marcar primeros de cada a√±o
        console.log('üè∑Ô∏è Marcando primeros documentos de cada a√±o...');
        for (const documento of documentos) {
            const match = documento.numeroRadicado.match(/^R(\d{4})-\d{3}$/);
            if (!match) {
                console.log(`‚ö†Ô∏è Formato inv√°lido ignorado: ${documento.numeroRadicado}`);
                continue;
            }
            
            const ano = match[1];
            
            if (!anosProcesados.has(ano)) {
                documento.primerRadicadoDelAno = true;
                await documentoRepository.save(documento);
                anosProcesados.add(ano);
                marcados++;
                console.log(`‚úÖ Marcado: ${documento.numeroRadicado} como primer radicado de ${ano}`);
            }
        }
        
        console.log(`\nüéâ PROCESO COMPLETADO:`);
        console.log(`üìä Documentos procesados: ${documentos.length}`);
        console.log(`üìÖ A√±os encontrados: ${anosProcesados.size}`);
        console.log(`‚úÖ Documentos marcados como primeros del a√±o: ${marcados}`);
        
        // 4. Mostrar resumen por a√±o
        console.log(`\nüìã RESUMEN POR A√ëO:`);
        const anosArray = Array.from(anosProcesados).sort();
        for (const ano of anosArray) {
            const primerRadicado = documentos.find(d => 
                d.numeroRadicado.startsWith(`R${ano}-`) && 
                d.primerRadicadoDelAno === true
            );
            console.log(`  ${ano}: ${primerRadicado?.numeroRadicado || 'No encontrado'}`);
        }
        
        // 5. Verificar en base de datos
        const conteoFinal = await documentoRepository.count({
            where: { primerRadicadoDelAno: true }
        });
        console.log(`\nüîç Verificaci√≥n en BD: ${conteoFinal} documentos marcados`);
        
    } catch (error) {
        console.error(`‚ùå Error en el proceso:`, error);
    } finally {
        await dataSource.destroy();
        console.log('üîå Conexi√≥n cerrada');
    }
}

// Exportar la funci√≥n para uso en otros scripts
export { marcarPrimerosRadicados };

// Si se ejecuta directamente, ejecutar la funci√≥n
if (require.main === module) {
    marcarPrimerosRadicados();
}